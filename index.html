<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>BIOHACKER // NEURAL INTERFACE v10.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://apis.google.com/js/api.js" onload="initGAPI()"></script>
    <style>
        :root { 
            --red: #ff003c; --blue: #00f3ff; --green: #39ff14; 
            --bg: #050505; --panel: rgba(20, 20, 25, 0.95);
            --safe-top: env(safe-area-inset-top);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); color: #e0e0e0; font-family: 'SF Mono', 'Menlo', monospace;
            margin: 0; padding: calc(var(--safe-top) + 10px) 12px 10px 12px;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- Header & Status --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .offline { background: var(--red); }

        /* --- Input Panel --- */
        .panel { 
            background: var(--panel); border: 1px solid #333; padding: 12px; border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); margin-bottom: 10px;
        }
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        label { font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 2px; display: block; }
        select, input { 
            width: 100%; background: #111; border: 1px solid #444; color: #fff; 
            padding: 10px; border-radius: 10px; font-size: 14px; outline: none;
        }
        .btn-main { 
            width: 100%; background: var(--red); color: white; border: none; padding: 14px; 
            border-radius: 12px; font-weight: 800; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px;
        }

        /* --- Dashboard Area (Scrollable) --- */
        #dashboard { flex: 1; overflow-y: auto; padding-right: 2px; }
        #dashboard::-webkit-scrollbar { width: 0; }

        /* --- Cards --- */
        .card { 
            background: #111; border: 1px solid #222; border-radius: 18px; padding: 12px; 
            margin-bottom: 10px; position: relative; border-left: 3px solid var(--blue);
        }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .substance-name { font-weight: bold; color: var(--blue); font-size: 13px; }

        /* --- Visualización Jeringa Pro --- */
        .syringe-container { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
        .syringe-v { 
            width: 32px; height: 100px; border: 2px solid #ddd; position: relative; 
            border-radius: 0 0 6px 6px; background: rgba(255,255,255,0.03); flex-shrink: 0;
        }
        .syringe-v::after { content: ''; position: absolute; top: -10px; left: 50%; width: 4px; height: 10px; background: #ddd; transform: translateX(-50%); }
        .fluid-segment { position: absolute; bottom: 0; width: 100%; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .pill-v { width: 32px; height: 40px; border: 2px solid var(--red); border-radius: 8px; position: relative; display: flex; align-items: center; justify-content: center; }

        /* --- Calendar Grid --- */
        .calendar { display: grid; grid-template-columns: repeat(11, 1fr); gap: 4px; }
        .day { 
            aspect-ratio: 1; background: #1a1a1a; border: 1px solid #333; border-radius: 5px; 
            display: flex; align-items: center; justify-content: center; font-size: 9px; color: #555; font-weight: bold;
        }
        .day.active { background: var(--red); color: white; border-color: var(--red); box-shadow: 0 0 10px rgba(255,0,60,0.4); }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="header">
    <div><span id="dot" class="status-dot offline"></span> <span style="font-size: 10px; letter-spacing: 1px;" id="user-info">AUTH REQUIRED</span></div>
    <button onclick="handleAuth()" id="auth-btn" style="background:none; border: 1px solid #444; color:#888; border-radius:6px; padding:4px 8px; font-size:9px;">SYNC DRIVE</button>
</div>

<div class="panel">
    <h2>NUEVA ENTRADA</h2>
    <div class="grid-form">
        <div>
            <label>Categoría</label>
            <select id="cat" onchange="syncSubstances()">
                <option value="oil">Aceites (Sem)</option>
                <option value="pep">Péptidos (Día)</option>
                <option value="hgh">HGH (Día)</option>
                <option value="oral">Oral (Día)</option>
            </select>
        </div>
        <div>
            <label>Compuesto</label>
            <select id="subst"></select>
        </div>
        <div>
            <label id="dose-label">Dosis Semanal (mg)</label>
            <input type="number" id="val" placeholder="0.0">
        </div>
        <div id="freq-box">
            <label>Frecuencia</label>
            <select id="freq">
                <option value="7">Diario (ED)</option>
                <option value="3.5">EOD</option>
                <option value="2" selected>2x / Sem</option>
            </select>
        </div>
    </div>
    <div id="extra-row" class="grid-form" style="margin-top:8px;">
        <div id="conc-box">
            <label>Concentración (mg/ml)</label>
            <input type="number" id="conc" value="250">
        </div>
        <div id="dilution-box" class="hidden" style="grid-column: span 2; display: flex; gap: 8px;">
            <div style="flex:1"><label>mg Vial</label><input type="number" id="v_mg" value="5"></div>
            <div style="flex:1"><label>ml Agua</label><input type="number" id="v_ml" value="2"></div>
        </div>
    </div>
    <button class="btn-main" onclick="addEntry()">Añadir al Protocolo</button>
</div>

<div id="dashboard"></div>

<script>
    const CLIENT_ID = '612276120104-tc46nv8856efe38fl7323n9cudkn8pp8.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    let protocol = [];
    let driveId = null;
    const colors = ['#00f3ff', '#39ff14', '#f3ff00', '#ff00ff', '#ff8800'];

    const catalog = {
        oil: ['Testo Cipio', 'Testo Enant', 'DHB', 'Primo', 'Masteron'],
        pep: ['BPC-157', 'TB-500', 'GHK-Cu'],
        hgh: ['Genotropin', 'Humatrope', 'Zptropin'],
        oral: ['Oxandrolona', 'Winstrol', 'Anadrol']
    };

    // --- Core Logic ---
    function initGAPI() {
        gapi.load('client:auth2', () => {
            gapi.client.init({ clientId: CLIENT_ID, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"], scope: SCOPES })
            .then(() => {
                const auth = gapi.auth2.getAuthInstance();
                auth.isSignedIn.listen(s => updateAuthStatus(s));
                updateAuthStatus(auth.isSignedIn.get());
            });
        });
    }

    function updateAuthStatus(s) {
        const dot = document.getElementById('dot');
        const info = document.getElementById('user-info');
        if(s) {
            dot.className = 'status-dot online';
            info.innerText = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile().getEmail();
            loadData();
        }
    }

    function handleAuth() {
        const auth = gapi.auth2.getAuthInstance();
        s = auth.isSignedIn.get();
        s ? saveData() : auth.signIn();
    }

    function syncSubstances() {
        const cat = document.getElementById('cat').value;
        document.getElementById('subst').innerHTML = catalog[cat].map(s => `<option>${s}</option>`).join('');
        document.getElementById('freq-box').classList.toggle('hidden', cat !== 'oil');
        document.getElementById('conc-box').classList.toggle('hidden', cat === 'pep' || cat === 'hgh');
        document.getElementById('dilution-box').classList.toggle('hidden', cat !== 'pep');
        document.getElementById('dose-label').innerText = cat === 'oil' ? 'Dosis Semanal (mg)' : (cat === 'pep' ? 'Dosis Día (mcg)' : (cat === 'hgh' ? 'Dosis Día (UI)' : 'Dosis Día (mg)'));
    }

    function addEntry() {
        const cat = document.getElementById('cat').value;
        const name = document.getElementById('subst').value;
        const val = parseFloat(document.getElementById('val').value) || 0;
        let dose = val; let ml = 0;

        if(cat === 'oil') {
            dose = val / parseFloat(document.getElementById('freq').value);
            ml = dose / parseFloat(document.getElementById('conc').value);
        } else if(cat === 'pep') {
            ml = (val / 1000) * (parseFloat(document.getElementById('v_ml').value) / parseFloat(document.getElementById('v_mg').value));
        } else if(cat === 'hgh') {
            ml = val * 0.1; // 1 UI = 0.1ml estándar
        }

        protocol.push({
            id: Date.now(), cat, name, dose, ml,
            unit: (cat === 'pep' ? 'mcg' : (cat === 'hgh' ? 'UI' : 'mg')),
            checks: new Array(31).fill(false),
            color: colors[protocol.length % colors.length]
        });
        saveData(); render();
    }

    function render() {
        const container = document.getElementById('dashboard');
        container.innerHTML = '';
        
        const oils = protocol.filter(p => p.cat === 'oil');
        const others = protocol.filter(p => p.cat !== 'oil');

        if(oils.length > 0) createCard(container, "STACK ACEITES", oils, true);
        others.forEach(o => createCard(container, o.name, [o], false));
    }

    function createCard(parent, title, items, isSyringe) {
        const ref = items[0];
        const totalMl = items.reduce((a, b) => a + b.ml, 0);
        const card = document.createElement('div');
        card.className = 'card';
        card.style.borderLeftColor = ref.color;

        let visualHTML = '';
        if(ref.cat === 'oral') {
            visualHTML = `<div class="pill-v" style="border-color:${ref.color}"><div style="width:15px; height:6px; background:${ref.color}; border-radius:3px;"></div></div>`;
        } else {
            // Jeringa con escala dinámica (v10.0)
            const capacity = totalMl <= 0.3 ? 0.3 : (totalMl <= 0.5 ? 0.5 : 1.0);
            visualHTML = `<div class="syringe-v" style="height: ${80 + (capacity*40)}px">`;
            items.forEach((item, idx) => {
                const height = (item.ml / capacity) * 100;
                const bottom = items.slice(0, idx).reduce((s, curr) => s + (curr.ml / capacity) * 100, 0);
                visualHTML += `<div class="fluid-segment" style="height:${height}%; bottom:${bottom}%; background:${item.color}; opacity:0.8;"></div>`;
            });
            visualHTML += `<div style="position:absolute; right:-25px; top:0; font-size:7px; color:#555;">${capacity}ml</div></div>`;
        }

        card.innerHTML = `
            <div class="card-header">
                <span class="substance-name">${title}</span>
                <span style="font-size:14px; color:var(--green); font-weight:800;">${totalMl > 0 ? totalMl.toFixed(2)+'ml' : ref.dose+ref.unit}</span>
                <button onclick="remove(${ref.id})" style="background:none; border:none; color:#444;">×</button>
            </div>
            <div class="syringe-container">
                ${visualHTML}
                <div style="font-size:10px; line-height:1.4;">
                    ${items.map(i => `<div>• ${i.name}: <span style="color:white">${i.dose.toFixed(1)}${i.unit}</span></div>`).join('')}
                </div>
            </div>
            <div class="calendar">
                ${ref.checks.map((c, idx) => `<div class="day ${c?'active':''}" onclick="toggle(${ref.id}, ${idx})">${idx+1}</div>`).join('')}
            </div>
        `;
        parent.appendChild(card);
    }

    function toggle(id, day) {
        const p = protocol.find(x => x.id === id);
        if(p.cat === 'oil') protocol.filter(x => x.cat === 'oil').forEach(x => x.checks[day] = !x.checks[day]);
        else p.checks[day] = !p.checks[day];
        if(navigator.vibrate) navigator.vibrate(30);
        saveData(); render();
    }

    function remove(id) { protocol = protocol.filter(x => x.id !== id); saveData(); render(); }

    // --- Drive Sync Engine ---
    async function saveData() {
        if(!gapi.auth2.getAuthInstance().isSignedIn.get()) return;
        const metadata = { 'name': 'bio_v10.json', 'mimeType': 'application/json' };
        const boundary = 'v10_sync';
        const body = `--${boundary}\nContent-Type: application/json\n\n${JSON.stringify(metadata)}\n--${boundary}\nContent-Type: application/json\n\n${JSON.stringify(protocol)}\n--${boundary}--`;
        
        gapi.client.request({
            path: driveId ? `/upload/drive/v3/files/${driveId}` : '/upload/drive/v3/files',
            method: driveId ? 'PATCH' : 'POST',
            params: { uploadType: 'multipart' },
            headers: { 'Content-Type': `multipart/related; boundary=${boundary}` },
            body: body
        }).execute(res => { driveId = res.id; console.log("Cloud Saved"); });
    }

    async function loadData() {
        const res = await gapi.client.drive.files.list({ q: "name = 'bio_v10.json' and trashed = false" });
        if(res.result.files.length > 0) {
            driveId = res.result.files[0].id;
            const file = await gapi.client.drive.files.get({ fileId: driveId, alt: 'media' });
            protocol = file.result || [];
            render();
        }
    }

    syncSubstances();
</script>
</body>
</html>
